<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3ì›” íŠ¹ìƒˆ ì±Œë¦°ì§€ - ì¹´ë“œ ë’¤ì§‘ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼ */
        body { margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f0f4f8; font-family: 'Pretendard', sans-serif; }
        .info-bar { margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; color: #333; background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; }
        span#timer { color: #d32f2f; font-family: monospace; font-size: 1.5rem; }
        
        .btn-rank { background: #764ba2; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; }
        .btn-reset { background: #999; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; }
        
        .game-board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 90%; max-width: 600px; perspective: 1000px; }
        .card { background-color: transparent; aspect-ratio: 3 / 4; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.5s; }
        .card.flip { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; backface-visibility: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-back { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: rotateY(0deg); }
        .card-back::after { content: "?"; opacity: 0.5; }
        .card-front { background-color: white; transform: rotateY(180deg); border: 2px solid #764ba2; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal h2 { margin-top: 0; color: #764ba2; }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        .btn-submit { background: #d32f2f; color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .btn-retry { background: #6c757d; color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        
        .rank-list { list-style: none; padding: 0; text-align: left; max-height: 300px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .rank-item:nth-child(1) { color: #d32f2f; font-weight: bold; }
        .rank-name { font-weight: bold; }
        .rank-score { font-family: monospace; }
        .close-btn { background: #999; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="info-bar">
        <div>â±ï¸ <span id="timer">00.00</span>ì´ˆ</div>
        <button class="btn-reset" onclick="initGame()">ğŸ”„ ë¦¬ì…‹</button>
        <button class="btn-rank" onclick="showRanking()">ğŸ† ìˆœìœ„</button>
    </div>

    <div class="game-board" id="gameBoard"></div>

    <div class="modal-overlay" id="submitModal">
        <div class="modal">
            <h2>ğŸ‰ ì™„ì£¼ ì„±ê³µ!</h2>
            <p>ê¸°ë¡: <strong id="finalScore" style="color:#d32f2f; font-size:1.5rem;">00.00</strong>ì´ˆ</p>
            
            <div class="input-group">
                <label>ì´ë¦„</label>
                <input type="text" id="userName" placeholder="ì˜ˆ: í™ê¸¸ë™">
            </div>
            
            <div class="input-group">
                <label>ì†Œì†/ê¸°ê´€</label>
                <input type="text" id="userParish" placeholder="ì˜ˆ: 1êµêµ¬, ì²­ë…„ë¶€">
            </div>
            
            <div class="input-group">
                <label>ì—°ë½ì²˜ (ë’¤ 4ìë¦¬)</label>
                <input type="text" id="userPhone" placeholder="ì„ ë¬¼ ì¦ì •ìš© í™•ì¸">
            </div>
            
            <button class="btn-submit" onclick="submitScore()">ğŸ† ì´ ê¸°ë¡ìœ¼ë¡œ ë“±ë¡í•˜ê¸°</button>
            <button class="btn-retry" onclick="retryGame()">ğŸ”„ ë§ˆìŒì— ì•ˆ ë“¤ì–´ìš”, ì¬ë„ì „!</button>
        </div>
    </div>

    <div class="modal-overlay" id="rankModal">
        <div class="modal">
            <h2>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (Top 10)</h2>
            <ul class="rank-list" id="rankList">
                <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
            <button class="btn-submit close-btn" onclick="closeRankModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ==========================================
        // â˜… Supabase ì„¤ì • (ê¸°ì¡´ í‚¤ ì‚¬ìš©)
        // ==========================================
        const SUPABASE_URL = 'https://bjnualkexnjtugecouiv.supabase.co'; // í”„ë¡œì íŠ¸ URL ë¶™ì—¬ë„£ê¸°
        const SUPABASE_KEY = 'sb_publishable_lR1Qts8oi7ksXUhkOHo21Q_9img50Sn'; // API Key (anon) ë¶™ì—¬ë„£ê¸°
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // ==========================================

        const cardIcons = ['ğŸ™','ğŸ™','ğŸ“–','ğŸ“–','â›ª','â›ª','ğŸ•Šï¸','ğŸ•Šï¸','â¤ï¸','â¤ï¸','ğŸ•¯ï¸','ğŸ•¯ï¸','ğŸ','ğŸ','ğŸ·','ğŸ·','ğŸ','ğŸ','ğŸ‘‘','ğŸ‘‘'];
        const board = document.getElementById('gameBoard');
        const timerElement = document.getElementById('timer');
        let cards = [], hasFlippedCard = false, lockBoard = false;
        let firstCard, secondCard, matchCount = 0;
        let startTime, timerInterval, isGameStarted = false;
        let currentScore = 0;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame() {
            board.innerHTML = ''; 
            matchCount = 0;
            isGameStarted = false;
            hasFlippedCard = false;
            lockBoard = false;
            firstCard = null;
            secondCard = null;
            timerElement.innerText = "00.00";
            clearInterval(timerInterval);
            
            const shuffledIcons = shuffle([...cardIcons]);
            shuffledIcons.forEach(icon => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.icon = icon;
                card.innerHTML = `<div class="card-face card-front">${icon}</div><div class="card-face card-back"></div>`;
                card.addEventListener('click', flipCard);
                board.appendChild(card);
            });
        }

        function startTimer() {
            if (isGameStarted) return;
            isGameStarted = true;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                currentScore = (Date.now() - startTime) / 1000;
                timerElement.innerText = currentScore.toFixed(2);
            }, 10);
        }

        function flipCard() {
            if (!isGameStarted) startTimer();
            if (lockBoard) return;
            if (this === firstCard) return;

            this.classList.add('flip');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }
            secondCard = this;
            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.dataset.icon === secondCard.dataset.icon;
            isMatch ? disableCards() : unflipCards();
        }

        // [í•µì‹¬] ì¹´ë“œë¥¼ ë§ì·„ì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            
            // â˜… ì¶”ê°€ëœ ë¶€ë¶„: ì§„ë™ ë° í­ì£½ íš¨ê³¼
            triggerMatchEffect();

            matchCount++;
            resetBoard();

            if (matchCount === 10) {
                clearInterval(timerInterval);
                setTimeout(() => {
                    // ê²Œì„ ëë‚¬ì„ ë•Œ ëŒ€í˜• í­ì£½!
                    triggerBigConfetti();
                    openSubmitModal();
                }, 500); 
            }
        }

        function unflipCards() {
            lockBoard = true;
            // í‹€ë ¸ì„ ë•Œë„ ì•½í•œ ì§„ë™ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì›í•˜ì‹œë©´ ì£¼ì„ í•´ì œ)
            // if (navigator.vibrate) navigator.vibrate(100); 
            
            setTimeout(() => {
                firstCard.classList.remove('flip');
                secondCard.classList.remove('flip');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        // ==========================================
        // â˜… ìƒˆë¡œ ì¶”ê°€ëœ íš¨ê³¼ í•¨ìˆ˜ë“¤
        // ==========================================
        
        // 1. ë§¤ì¹­ ì„±ê³µ ì‹œ íš¨ê³¼ (ì§„ë™ + ì†Œí˜• í­ì£½)
        function triggerMatchEffect() {
            // ì§„ë™ (ì•ˆë“œë¡œì´ë“œ ì§€ì›, ì•„ì´í°ì€ ì„¤ì •ì— ë”°ë¼ ë‹¤ë¦„)
            if (navigator.vibrate) {
                navigator.vibrate(200); // 200ms ì§„ë™
            }

            // í­ì£½ íš¨ê³¼ (í™”ë©´ ì¤‘ì•™ì—ì„œ ì‚´ì§ í„°ì§)
            confetti({
                particleCount: 60,
                spread: 50,
                origin: { y: 0.6 },
                colors: ['#764ba2', '#667eea', '#ffffff'] // êµíšŒ ëŠë‚Œ ìƒ‰ìƒ
            });
        }

        // 2. ê²Œì„ í´ë¦¬ì–´ ì‹œ íš¨ê³¼ (ëŒ€í˜• í­ì£½)
        function triggerBigConfetti() {
            var duration = 2000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 }
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 }
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function openSubmitModal() {
            document.getElementById('finalScore').innerText = currentScore.toFixed(2);
            document.getElementById('submitModal').style.display = 'flex';
        }

        function retryGame() {
            document.getElementById('submitModal').style.display = 'none';
            document.getElementById('userName').value = '';
            document.getElementById('userParish').value = '';
            document.getElementById('userPhone').value = '';
            initGame(); 
        }

        async function submitScore() {
            const name = document.getElementById('userName').value;
            const parish = document.getElementById('userParish').value;
            const phone = document.getElementById('userPhone').value;

            if (!name || !parish || !phone) {
                alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const { error } = await supabaseClient
                .from('records')
                .insert({ name: name, parish: parish, phone: phone, score: currentScore });

            if (error) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            } else {
                alert("ê¸°ë¡ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                document.getElementById('submitModal').style.display = 'none';
                showRanking(); 
            }
        }

        async function showRanking() {
            document.getElementById('rankModal').style.display = 'flex';
            const list = document.getElementById('rankList');
            list.innerHTML = '<li>ë¡œë”© ì¤‘...</li>';

            const { data, error } = await supabaseClient
                .from('records')
                .select('name, parish, score')
                .order('score', { ascending: true })
                .limit(10);

            if (error) {
                console.error(error);
                list.innerHTML = '<li>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
                return;
            }

            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = '<li>ì•„ì§ ë“±ë¡ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            } else {
                data.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.classList.add('rank-item');
                    li.innerHTML = `
                        <span class="rank-name">${index + 1}ìœ„. ${item.name} (${item.parish})</span>
                        <span class="rank-score">${item.score.toFixed(2)}ì´ˆ</span>
                    `;
                    list.appendChild(li);
                });
            }
        }

        function closeRankModal() {
            document.getElementById('rankModal').style.display = 'none';
        }

        initGame();
    </script>
</body>
</html>
