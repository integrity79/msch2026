<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3ì›” íŠ¹ìƒˆ ì±Œë¦°ì§€ - ì¹´ë“œ ë’¤ì§‘ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ë­í‚¹/ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        body { margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f0f4f8; font-family: 'Pretendard', sans-serif; }
        .info-bar { margin-bottom: 20px; font-size: 1.5rem; font-weight: bold; color: #333; background: white; padding: 10px 30px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; gap: 20px; align-items: center; }
        span#timer { color: #d32f2f; font-family: monospace; }
        .btn-rank { background: #764ba2; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; }
        .game-board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 90%; max-width: 600px; perspective: 1000px; }
        .card { background-color: transparent; aspect-ratio: 3 / 4; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.5s; }
        .card.flip { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; backface-visibility: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-back { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: rotateY(0deg); }
        .card-back::after { content: "?"; opacity: 0.5; }
        .card-front { background-color: white; transform: rotateY(180deg); border: 2px solid #764ba2; }

        /* ëª¨ë‹¬ì°½ (ì…ë ¥í¼/ë­í‚¹) ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal h2 { margin-top: 0; color: #764ba2; }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-submit { background: #d32f2f; color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .rank-list { list-style: none; padding: 0; text-align: left; max-height: 300px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .rank-item:nth-child(1) { color: #d32f2f; font-weight: bold; } /* 1ë“± ê°•ì¡° */
        .rank-name { font-weight: bold; }
        .rank-score { font-family: monospace; }
        .close-btn { background: #999; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="info-bar">
        <div>â±ï¸ <span id="timer">00.00</span>ì´ˆ</div>
        <button class="btn-rank" onclick="showRanking()">ğŸ† ìˆœìœ„ ë³´ê¸°</button>
    </div>

    <div class="game-board" id="gameBoard"></div>

    <div class="modal-overlay" id="submitModal">
        <div class="modal">
            <h2>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
            <p>ê¸°ë¡: <strong id="finalScore" style="color:#d32f2f; font-size:1.5rem;">00.00</strong>ì´ˆ</p>
            <div class="input-group">
                <label>ì´ë¦„</label>
                <input type="text" id="userName" placeholder="ì˜ˆ: í™ê¸¸ë™">
            </div>
            <div class="input-group">
                <label>êµêµ¬ (ìˆ«ìë§Œ ì…ë ¥)</label>
                <input type="text" id="userParish" placeholder="ì˜ˆ: 1">
            </div>
            <div class="input-group">
                <label>ì—°ë½ì²˜ (ë’¤ 4ìë¦¬)</label>
                <input type="text" id="userPhone" placeholder="ì„ ë¬¼ ì¦ì •ìš© í™•ì¸">
            </div>
            <button class="btn-submit" onclick="submitScore()">ê¸°ë¡ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div class="modal-overlay" id="rankModal">
        <div class="modal">
            <h2>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (Top 10)</h2>
            <ul class="rank-list" id="rankList">
                <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
            <button class="btn-submit close-btn" onclick="closeRankModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ==========================================
        // â˜… ì—¬ê¸°ë¥¼ ê¼­ ìˆ˜ì •í•´ì£¼ì„¸ìš”! (Supabase ì„¤ì •)
        // ==========================================
        const SUPABASE_URL = 'https://bjnualkexnjtugecouiv.supabase.co'; // í”„ë¡œì íŠ¸ URL ë¶™ì—¬ë„£ê¸°
        const SUPABASE_KEY = 'sb_publishable_lR1Qts8oi7ksXUhkOHo21Q_9img50Sn'; // API Key (anon) ë¶™ì—¬ë„£ê¸°
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // ==========================================

        // ê²Œì„ ë³€ìˆ˜
        const cardIcons = ['ğŸ™','ğŸ™','ğŸ“–','ğŸ“–','â›ª','â›ª','ğŸ•Šï¸','ğŸ•Šï¸','â¤ï¸','â¤ï¸','ğŸ•¯ï¸','ğŸ•¯ï¸','ğŸ','ğŸ','ğŸ·','ğŸ·','ğŸ','ğŸ','ğŸ‘‘','ğŸ‘‘'];
        const board = document.getElementById('gameBoard');
        const timerElement = document.getElementById('timer');
        let cards = [], hasFlippedCard = false, lockBoard = false;
        let firstCard, secondCard, matchCount = 0;
        let startTime, timerInterval, isGameStarted = false;
        let currentScore = 0;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame() {
            board.innerHTML = ''; // ë³´ë“œ ì´ˆê¸°í™”
            matchCount = 0;
            isGameStarted = false;
            timerElement.innerText = "00.00";
            clearInterval(timerInterval);
            
            const shuffledIcons = shuffle([...cardIcons]);
            shuffledIcons.forEach(icon => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.icon = icon;
                card.innerHTML = `<div class="card-face card-front">${icon}</div><div class="card-face card-back"></div>`;
                card.addEventListener('click', flipCard);
                board.appendChild(card);
            });
        }

        function startTimer() {
            if (isGameStarted) return;
            isGameStarted = true;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                currentScore = (Date.now() - startTime) / 1000;
                timerElement.innerText = currentScore.toFixed(2);
            }, 10);
        }

        function flipCard() {
            if (!isGameStarted) startTimer();
            if (lockBoard) return;
            if (this === firstCard) return;

            this.classList.add('flip');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }
            secondCard = this;
            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.dataset.icon === secondCard.dataset.icon;
            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            matchCount++;
            resetBoard();

            if (matchCount === 10) {
                clearInterval(timerInterval);
                setTimeout(openSubmitModal, 500); // ê²Œì„ ì¢…ë£Œ ì‹œ ì…ë ¥ì°½ ì—´ê¸°
            }
        }

        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('flip');
                secondCard.classList.remove('flip');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        // --- ì—¬ê¸°ì„œë¶€í„° ë°ì´í„°ë² ì´ìŠ¤/UI ê´€ë ¨ ê¸°ëŠ¥ ---

        // 1. ê¸°ë¡ ì œì¶œì°½ ì—´ê¸°
        function openSubmitModal() {
            document.getElementById('finalScore').innerText = currentScore.toFixed(2);
            document.getElementById('submitModal').style.display = 'flex';
        }

        // 2. Supabaseì— ê¸°ë¡ ì €ì¥ (ê°€ì¥ ì¤‘ìš”!)
        async function submitScore() {
            const name = document.getElementById('userName').value;
            const parish = document.getElementById('userParish').value;
            const phone = document.getElementById('userPhone').value;

            if (!name || !parish || !phone) {
                alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const { error } = await supabase
                .from('records') // ì•„ê¹Œ ë§Œë“  í…Œì´ë¸” ì´ë¦„
                .insert({ name: name, parish: parish, phone: phone, score: currentScore });

            if (error) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            } else {
                alert("ê¸°ë¡ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                document.getElementById('submitModal').style.display = 'none';
                showRanking(); // ë“±ë¡ í›„ ë°”ë¡œ ë­í‚¹ ë³´ì—¬ì£¼ê¸°
                // initGame(); // ì›í•˜ë©´ ê²Œì„ ì¬ì‹œì‘
            }
        }

        // 3. ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° (Top 10)
        async function showRanking() {
            document.getElementById('rankModal').style.display = 'flex';
            const list = document.getElementById('rankList');
            list.innerHTML = '<li>ë¡œë”© ì¤‘...</li>';

            // ì ìˆ˜(score)ê°€ ë‚®ì€ ìˆœì„œ(asc)ë¡œ ì •ë ¬í•´ì„œ 10ê°œ ê°€ì ¸ì˜¤ê¸°
            const { data, error } = await supabase
                .from('records')
                .select('name, parish, score')
                .order('score', { ascending: true })
                .limit(10);

            if (error) {
                list.innerHTML = '<li>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
                return;
            }

            list.innerHTML = '';
            data.forEach((item, index) => {
                const li = document.createElement('li');
                li.classList.add('rank-item');
                // ì—°ë½ì²˜ëŠ” ìˆ¨ê¸°ê³  ì´ë¦„(êµêµ¬) í˜•ì‹ìœ¼ë¡œ ì¶œë ¥
                li.innerHTML = `
                    <span class="rank-name">${index + 1}ìœ„. ${item.name} (${item.parish}êµêµ¬)</span>
                    <span class="rank-score">${item.score.toFixed(2)}ì´ˆ</span>
                `;
                list.appendChild(li);
            });
        }

        function closeRankModal() {
            document.getElementById('rankModal').style.display = 'none';
        }

        initGame();
    </script>
</body>
</html>
